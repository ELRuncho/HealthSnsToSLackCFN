AWSTemplateFormatVersion: '2010-09-09'
Description: This template deploys a cloudwatch event, sns topci and lambda function in order to send AWS health alerts to slack
Parameters:
  Key:
    Description: Key for taging 
    Type: String
  Value:
    Description: Value for the tag Key
    Type: String
  SlackChannel:
    Description: Name of the Channel where you want the alerts to be display
    Type: String
  WebHook:
    Description: Slack's incoming webhook URL 
    Type: String

Resources:

  Security:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: infra/infra.yaml
      Parameters:
        EnvironmentName: !Ref AWS::StackName
        Key: !Ref Key
        Value: !Ref Value

  EventAndTopic:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: EventAndTopic/EventAndTopic.yaml
      Parameters:
        EnvironmentName: !Ref AWS::StackName

        Role: !GetAtt ExtractorSecurity.Outputs.ExtractorRole
        DestinationBucket: !GetAtt ExtractorStorage.Outputs.Bucket
        SecGroups: !GetAtt ExtractorSecurity.Outputs.SecG
        CodeBucket: config-bucket-us-west-2-051291311226
        CodeKey: InMetAppTest2.zip

  LambdaFunction:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3-us-west-2.amazonaws.com/inmetsam-template/lambda/grafanaLib.yaml
      Parameters:
        EnvironmentName: !Ref AWS::StackName
        Role: !GetAtt Security.Outputs.Role
        KmsKey: !GetAtt Security.Outputs.Key
        SNSTopic: !GetAtt EventAndTopic.Outputs.SNSArn
        SlackChannel: !Ref SlackChannel
        WebHook: !Ref WebHook